# 更新日志 | CHANGELOG

本文档详细记录ConfigCraft项目的版本更新历史、技术问题解决方案及改进措施。

## 版本说明

版本号格式：`主版本号.次版本号.修订号`
- **主版本号**：重大架构变更或不向后兼容的更新
- **次版本号**：新增功能，向后兼容
- **修订号**：问题修复和小改进

---

## [v0.3.5] - 2025-08-24 | 品牌重塑 + 智能状态栏

### 🎯 重大更新
- **品牌升级**：从"DHF Configuration Manager"正式重命名为"ConfigCraft"
- **通用化改造**：移除特定硬件依赖，成为通用配置管理工具
- **开源准备**：代码结构优化，文档完善，适合开源发布

### ✨ 智能状态栏系统
**新功能**：
- 底部状态栏显示当前配置文件路径（相对路径，最多显示两级目录）
- 右侧显示版本信息，与关于对话框保持同步
- 自动识别文件类型：`Schema模式` vs `当前文件`

**技术实现**：
```go
// 新增版本管理模块
internal/version/version.go
- Version = "0.3.5"
- AppName = "ConfigCraft"  
- GetVersionString() // 统一版本字符串格式
```

### 🔧 版本管理统一化
**问题**：版本信息分散在多个地方，维护困难
**解决方案**：
- 新建`internal/version/version.go`模块
- 所有版本显示统一引用同一常量
- 状态栏、关于对话框自动同步

### 📋 项目结构优化
**清理内容**：
- 删除`DHF-Config-Manager-Project-Plan.md`（过时文档）
- 删除`customer.conf`（测试文件）
- 删除编译产生的临时文件

**重命名更新**：
- 模块名：`dhf-config-manager` → `configcraft`
- 执行文件：`dhf-config-manager.exe` → `configcraft.exe`
- 应用标题：统一更新为"ConfigCraft"

---

## [v0.3.4] - 2025-08-24 | 原生文件对话框重大突破

### 🎯 核心问题解决
**问题描述**：Fyne文件对话框在Windows上无法从当前目录开始选择文件
**影响范围**：用户每次都需要手动导航到项目目录，体验极差

### 🔧 技术解决方案
**根本原因**：
```go
// Fyne的dialog.NewFileOpen()在Windows上的问题
dialog.SetLocation() // 在Windows环境下不生效
```

**解决实现**：
1. **集成zenity库**：`github.com/ncruces/zenity v0.10.14`
2. **新增组件**：`internal/ui/components/zenity_dialog.go`
3. **原生对话框**：调用Windows系统原生文件选择器

```go
// 关键代码片段
zenityDialog := NewZenityFileDialog()
filePath, err := zenityDialog.ShowOpenDialog("选择配置文件")
```

### 🛠️ 配置加载逻辑修复
**问题1**：Schema文件被错误识别为用户配置文件
```go
// 修复前：没有有效的schema验证
// 修复后：添加sections数量检查
if len(schema.Sections) == 0 {
    return fmt.Errorf("file does not contain valid schema sections")
}
```

**问题2**：`LoadUserConfig`返回空配置而非错误
```go
// 修复：正确返回文件读取错误
if err := os.ReadFile(filePath); err != nil {
    return nil, fmt.Errorf("failed to read user config file: %w", err)
}
```

### 📊 用户体验提升
- **文件选择**：现在从工具运行目录开始，符合用户预期
- **错误处理**：精确的错误信息，便于问题诊断
- **文件识别**：自动区分schema文件和配置文件

---

## [v0.3.3] - 2025-08-22 | 配置编辑器UI革命性改进

### 🎨 界面设计突破
**核心问题**：右侧配置编辑器布局混乱，配置项边界不清
**设计理念**：每个配置项独立成卡片，统一视觉层次

### ✨ 新增字段类型和功能
**combo字段类型**：
```yaml
field_name:
  type: "combo"
  options: [{value: "option1", label: "选项1"}]
  placeholder: "或输入自定义值"
```
- 结合下拉选择和手动输入
- 既可快速选择预设值，又可输入自定义内容

**增强属性支持**：
- `description`：字段下方显示详细说明
- `tooltip`：点击💡按钮显示格式化帮助
- `placeholder`：输入框占位符文字

### 🏗️ 布局架构重建
**独立卡片设计**：
```
┌─────── 配置项卡片 ───────┐
│ 🏷️ 字段标题 + 💡 帮助    │
│ ─────────────────────  │
│ 📝 描述信息 (斜体)      │
│ ─────────────────────  │
│ [配置控件区域]          │
└─────────────────────────┘
```

**技术实现**：
```go
// 每个配置项独立的容器和样式
configCard := container.NewBorder(titleRow, nil, nil, nil, controlWidget)
configCards = append(configCards, configCard)
```

### 📊 智能文件检测
**问题**：无法区分schema文件和用户配置文件
**解决方案**：
- Schema文件：包含`sections`定义结构
- 配置文件：包含`values`实际数据
- 自动识别并采用不同处理逻辑

---

## [v0.3.2] - 2025-08-21 | 配置分组顺序一致性修复

### 🔧 根本问题诊断
**现象**：相同YAML文件每次加载时配置分组位置随机变化
**根本原因**：Go语言map遍历的随机性特性

**影响位置**：
1. `parser.go`：conf文件生成时的遍历
2. `app.go`：动态schema生成时的遍历
3. `tree.go`：界面树形控件的渲染

### 🎯 统一排序解决方案
**排序优先级定义**：
```go
sectionOrder := map[string]int{
    "basic":      1,  // 基础配置
    "key_actions": 2, // 按键配置
    "led_config": 3,  // LED配置
    "factory":    4,  // 工厂设置
    "advanced":   5,  // 高级设置
}
```

**排序逻辑**：
1. 有优先级的section按优先级排序
2. 无优先级的section按字典序排序
3. 三个关键位置使用相同的排序函数

### 📊 实施效果
- **界面稳定性**：相同配置文件每次加载界面完全一致
- **逻辑顺序**：按配置重要性优先级排列，符合使用习惯
- **代码一致性**：消除了Go map遍历随机性的影响

---

## [v0.3.1] - 2025-08-21 | 树形控件闪烁问题彻底解决

### 🎯 Fyne Tree组件问题
**问题描述**：展开/收缩节点时出现严重闪烁和位置漂移
**技术原因**：Fyne Tree的内部刷新机制会重建整个节点结构

### 🔧 自定义树形控件解决方案
**设计思路**：使用VBox容器和动态渲染替代Fyne Tree

**核心实现**：
```go
type ConfigTree struct {
    container         fyne.CanvasObject
    vbox             *fyne.Container
    nodes            map[string]*TreeNode
    selectedNode     *TreeNode
}
```

**渲染机制**：
1. **节点管理**：自主控制节点状态和层级关系
2. **动态渲染**：仅渲染可见节点，避免不必要的重绘
3. **流畅动画**：展开/收缩操作无闪烁，响应即时

### ✨ 界面优化细节
**简约箭头设计**：
- 收缩状态：`▶` (右箭头)
- 展开状态：`▼` (下箭头)
- 按钮尺寸：20x20像素，紧凑美观

**布局优化**：
- 缩进调整为2个空格，节省水平空间
- 移除冗余装饰，保持简洁专业风格
- 完美对齐所有节点，视觉效果统一

---

## [v0.3.0] - 2025-08-21 | 通用YAML配置支持

### 🎯 架构重大升级
**设计目标**：从特定schema依赖转向通用YAML支持
**核心改进**：
- 移除对固定schema文件的强依赖
- 支持任意结构的YAML配置文件
- 智能界面生成系统

### ✨ 智能配置系统
**动态Schema生成**：
```go
func (a *App) generateSchemaFromConfig(userConfig *models.UserConfig) *models.Schema {
    // 从配置内容自动推断UI结构
    // 支持多层级配置：section.group.field
    // 自动识别数据类型：boolean, number, string, enum
}
```

**智能保存逻辑**：
- 自动覆盖原YAML文件
- 同时生成对应的conf配置文件
- 保持文件名一致性：`config.yaml` → `config.conf`

---

## [v0.2.1] - 2025-08-20 | 中文显示问题彻底解决

### 🌍 中文字体显示突破
**历史问题**：GUI界面中文字符显示为方块乱码
**根本原因**：Fyne框架的字体支持机制限制

### 🔧 技术解决方案
**关键发现**：
1. Fyne不支持TTC字体集合文件
2. 需要使用单个TTF字体文件
3. 微软雅黑的msyh.ttc格式不被支持

**最终方案**：
```go
// main.go 中的关键设置
os.Setenv("FYNE_FONT", "C:\\Windows\\Fonts\\simhei.ttf")
```

**字体选择**：
- **字体文件**：simhei.ttf (黑体)
- **路径位置**：Windows系统字体目录
- **支持范围**：完整的中文字符集
- **显示效果**：清晰美观的中文渲染

### 📊 实施效果
- **100%中文支持**：所有界面文字正常显示
- **跨系统兼容**：在不同Windows版本上稳定工作
- **性能优化**：字体加载无延迟，界面响应快速

---

## [v0.2.0] - 2025-08-20 | 现代化GUI架构重建

### 🎨 界面架构全面升级
**设计理念**：现代化、简洁、功能明确的双面板布局

**布局结构**：
```
┌─────── 工具栏 ──────┐
├─────────────────────┤
│ 配置分组 │ 配置选项  │
│ (30%)   │ (70%)    │
│         │          │
└─────────────────────┘
```

### ✨ 组件优化
**工具栏重构**：
- 位置调整：顶部左上角单行排列
- 按钮分组：文件操作 + 分隔符 + 帮助
- 现代化About对话框：版本信息和项目介绍

**响应式设计**：
- 固定窗口尺寸：900x650像素
- 左右面板比例：30% : 70%
- 自适应内容区域高度

### 🔧 技术改进
**组件架构**：
- 模块化UI组件设计
- 清晰的接口定义和类型约束
- 统一的事件回调机制

---

## [v0.1.0] - 2025-01-19 | 项目基础架构建立

### 🎉 项目初始化
**核心架构**：基于Go + Fyne的跨平台GUI应用
**设计模式**：MVC架构，模块化组件设计

### ✨ 基础功能实现
**配置管理系统**：
- YAML schema驱动的动态UI生成
- 支持多种配置字段类型
- 实时配置预览和验证

**文件操作系统**：
- YAML配置文件读写
- DHF conf格式输出
- 配置模板系统

**GUI界面框架**：
- 树形导航控件
- 动态表单编辑器
- 工具栏和状态栏

### 🔧 技术栈选择
**开发语言**：Go 1.21+
**GUI框架**：Fyne v2.4.3
**构建工具**：TDM-GCC (CGO支持)
**配置格式**：YAML + 自定义conf

### 📊 支持范围
**配置类型覆盖**：
- 基础硬件配置 (IC型号、功放控制等)
- 按键功能映射 (通话、音乐场景)
- LED灯效设置 (连接状态、系统事件)
- 工厂测试模式 (DUT、重置配置)
- 高级功能选项 (降噪、三方通话等)

### 🐛 已知限制
- ❌ 中文字体显示问题 (v0.2.1已解决)
- ❌ 配置文件导入功能缺失 (计划中)
- ❌ 高级验证和错误提示不完善 (改进中)

---

## 技术债务记录

### 🚧 待解决问题

**功能完善**：
- [ ] 配置文件反向导入 (conf → YAML)
- [ ] 配置验证和错误检查系统
- [ ] 批量配置处理工具
- [ ] 配置模板管理系统

**性能优化**：
- [ ] 大型配置文件加载优化
- [ ] UI响应性能提升
- [ ] 内存使用优化

**用户体验**：
- [ ] 多语言界面支持
- [ ] 键盘快捷键系统
- [ ] 配置搜索和筛选功能
- [ ] 撤销/重做操作支持

### 🔍 代码质量改进

**测试覆盖**：
- [ ] 单元测试框架建立
- [ ] 集成测试用例编写
- [ ] 自动化测试流水线

**文档完善**：
- [ ] API文档自动生成
- [ ] 开发指南详细化
- [ ] 用户手册编写

---

## 贡献指南

### 🐛 Bug报告格式
```markdown
**问题描述**：简洁描述问题现象
**复现步骤**：详细的操作步骤
**预期行为**：期望的正确行为
**实际行为**：当前的错误行为
**环境信息**：操作系统、版本等
**错误日志**：相关的错误信息
```

### ✨ 功能请求格式
```markdown
**需求背景**：为什么需要这个功能
**功能描述**：详细的功能说明
**使用场景**：具体的应用情况
**实现建议**：可能的技术方案
```

### 📋 开发流程
1. Fork项目并创建功能分支
2. 编写代码并确保测试通过
3. 更新相关文档
4. 提交Pull Request并描述变更
5. 代码审查和问题修复
6. 合并到主分支并发布

---

*ConfigCraft - 让配置管理变得简单高效* 🛠️